# بهبودهای سیستم محافظت در برابر حملات Brute Force

## مقدمه

این سند خلاصه‌ای از بهبودهای اعمال شده در سیستم محافظت در برابر حملات Brute Force است که برای تقویت امنیت سیستم Smart Camera انجام شده است.

## مشکلات شناسایی شده در تحلیل امنیتی

### 1. محدودیت‌های سیستم فعلی
- **محدودیت ساده**: فقط مسدودسازی IP پس از 5 تلاش ناموفق
- **عدم تشخیص الگوهای مشکوک**: عدم شناسایی حملات Dictionary Attack
- **عدم تأخیر پیشرونده**: عدم اعمال تأخیرهای افزایشی
- **عدم قفل حساب**: عدم قفل حساب کاربر پس از تلاش‌های مکرر
- **عدم اعلان ادمین**: عدم اطلاع‌رسانی به ادمین در صورت حملات شدید

### 2. آسیب‌پذیری‌های احتمالی
- امکان حملات Dictionary Attack
- عدم محافظت در برابر حملات خودکار
- عدم تشخیص الگوهای مشکوک
- عدم محدودیت زمانی مناسب

## بهبودهای اعمال شده

### 1. پیکربندی پیشرفته Brute Force Protection

```python
BRUTE_FORCE_CONFIG = {
    'PROGRESSIVE_DELAYS': True,  # تأخیرهای پیشرونده
    'DELAY_MULTIPLIER': 2,  # ضریب افزایش تأخیر
    'BASE_DELAY_SECONDS': 1,  # تأخیر پایه
    'MAX_DELAY_SECONDS': 300,  # حداکثر تأخیر (5 دقیقه)
    'ADMIN_NOTIFICATION_THRESHOLD': 10,  # آستانه اعلان ادمین
    'GLOBAL_ATTEMPT_TRACKING': True,  # ردیابی جهانی تلاش‌ها
    'SUSPICIOUS_PATTERN_DETECTION': True,  # تشخیص الگوهای مشکوک
    'ACCOUNT_LOCKOUT_THRESHOLD': 15,  # آستانه قفل حساب
    'ACCOUNT_LOCKOUT_DURATION': 3600,  # مدت قفل حساب (1 ساعت)
    'IP_BLACKLIST_THRESHOLD': 50,  # آستانه سیاه‌لیست IP
    'IP_BLACKLIST_DURATION': 86400,  # مدت سیاه‌لیست IP (24 ساعت)
    'ENABLE_CAPTCHA_AFTER': 3,  # فعال‌سازی CAPTCHA پس از 3 تلاش
    'ENABLE_2FA_AFTER': 5,  # پیشنهاد 2FA پس از 5 تلاش
    'LOG_FAILED_ATTEMPTS': True,  # ثبت تلاش‌های ناموفق
    'LOG_SUCCESSFUL_ATTEMPTS': True,  # ثبت تلاش‌های موفق
    'ENABLE_ACCOUNT_RECOVERY': True,  # فعال‌سازی بازیابی حساب
    'RECOVERY_COOLDOWN': 1800,  # زمان انتظار بازیابی (30 دقیقه)
}
```

### 2. ردیابی پیشرفته تلاش‌های لاگین

#### تابع `check_login_attempts` بهبود یافته:
```python
def check_login_attempts(client_ip: str, username: str = None) -> tuple[bool, dict]:
    """بررسی پیشرفته تلاش‌های لاگین با محافظت پیشرفته"""
```

**ویژگی‌های جدید:**
- بررسی سیاه‌لیست IP
- بررسی قفل حساب
- بازگرداندن اطلاعات تفصیلی
- تشخیص نیاز به CAPTCHA و 2FA

#### تابع `record_login_attempt` بهبود یافته:
```python
def record_login_attempt(client_ip: str, success: bool, username: str = None):
    """ثبت پیشرفته تلاش‌های لاگین با محافظت پیشرفته"""
```

**ویژگی‌های جدید:**
- ثبت تاریخچه تلاش‌ها
- محاسبه تأخیرهای پیشرونده
- ثبت رویدادهای امنیتی
- اعلان ادمین
- قفل حساب و سیاه‌لیست IP

### 3. تشخیص الگوهای مشکوک

#### تابع `detect_suspicious_patterns`:
```python
def detect_suspicious_patterns(client_ip: str, username: str = None) -> dict:
    """تشخیص الگوهای مشکوک برای محافظت پیشرفته"""
```

**الگوهای تشخیص داده شده:**
- **حملات Dictionary**: تلاش با چندین نام کاربری مختلف
- **تلاش‌های سریع**: تعداد زیاد تلاش در زمان کوتاه
- **الگوهای زمانی**: فاصله‌های منظم (حملات خودکار)
- **امتیاز ریسک کلی**: محاسبه ریسک کلی بر اساس الگوها

### 4. تأخیرهای پیشرونده

#### تابع `apply_progressive_delay`:
```python
def apply_progressive_delay(client_ip: str) -> float:
    """اعمال تأخیر پیشرونده بر اساس تلاش‌های ناموفق"""
```

**ویژگی‌ها:**
- تأخیر پایه: 1 ثانیه
- ضریب افزایش: 2 (دو برابر شدن)
- حداکثر تأخیر: 5 دقیقه
- فرمول: `min(base_delay * (multiplier ^ attempts), max_delay)`

### 5. وضعیت جامع Brute Force

#### تابع `get_brute_force_status`:
```python
def get_brute_force_status(client_ip: str, username: str = None) -> dict:
    """دریافت وضعیت جامع محافظت Brute Force"""
```

**اطلاعات بازگردانده شده:**
- وضعیت مجاز بودن
- جزئیات مسدودسازی
- الگوهای مشکوک
- وضعیت سیاه‌لیست IP
- وضعیت قفل حساب
- نیاز به CAPTCHA/2FA
- تأخیر پیشرونده

### 6. ردیابی جهانی

#### متغیرهای جهانی جدید:
```python
global_login_attempts = {}  # ردیابی تلاش‌ها در تمام IPها
global_suspicious_ips = set()  # IPهای مشکوک
global_locked_accounts = {}  # حساب‌های قفل شده
global_blacklisted_ips = {}  # IPهای سیاه‌لیست شده
```

## سطوح محافظت

### سطح 1: تأخیر پیشرونده (1-3 تلاش)
- اعمال تأخیرهای کوتاه
- ثبت تلاش‌ها

### سطح 2: CAPTCHA (3+ تلاش)
- فعال‌سازی CAPTCHA
- تأخیرهای بیشتر

### سطح 3: پیشنهاد 2FA (5+ تلاش)
- پیشنهاد فعال‌سازی 2FA
- ثبت رویدادهای امنیتی

### سطح 4: قفل حساب (15+ تلاش)
- قفل موقت حساب (1 ساعت)
- اعلان ادمین

### سطح 5: سیاه‌لیست IP (50+ تلاش)
- سیاه‌لیست IP (24 ساعت)
- ثبت رویداد بحرانی

## بهبودهای امنیتی

### 1. ثبت و نظارت
- ثبت تمام تلاش‌های ناموفق
- ثبت تلاش‌های موفق برای حسابرسی
- ثبت رویدادهای امنیتی
- اعلان ادمین در صورت حملات شدید

### 2. تشخیص هوشمند
- تشخیص حملات Dictionary Attack
- تشخیص حملات خودکار
- محاسبه امتیاز ریسک
- شناسایی الگوهای مشکوک

### 3. پاسخ‌های تطبیقی
- تأخیرهای پیشرونده
- فعال‌سازی CAPTCHA
- پیشنهاد 2FA
- قفل حساب و IP

### 4. مدیریت حساب
- قفل موقت حساب
- امکان بازیابی حساب
- محدودیت زمانی
- پاک‌سازی خودکار

## تست‌های امنیتی

### تست‌های پیاده‌سازی شده:
1. **تست ردیابی پایه**: بررسی ردیابی تلاش‌های لاگین
2. **تست CAPTCHA**: بررسی فعال‌سازی CAPTCHA
3. **تست 2FA**: بررسی پیشنهاد 2FA
4. **تست قفل حساب**: بررسی قفل حساب
5. **تست سیاه‌لیست IP**: بررسی سیاه‌لیست IP
6. **تست تأخیرهای پیشرونده**: بررسی محاسبه تأخیرها
7. **تست تشخیص الگوهای مشکوک**: بررسی تشخیص الگوها
8. **تست بازنشانی موفق**: بررسی بازنشانی پس از لاگین موفق
9. **تست وضعیت جامع**: بررسی تابع وضعیت جامع
10. **تست بازنشانی زمانی**: بررسی بازنشانی پس از گذشت زمان

## مزایای سیستم جدید

### 1. امنیت بالاتر
- محافظت چندلایه
- تشخیص هوشمند حملات
- پاسخ‌های تطبیقی

### 2. تجربه کاربری بهتر
- تأخیرهای منطقی
- پیام‌های واضح
- امکان بازیابی

### 3. نظارت بهتر
- ثبت کامل رویدادها
- اعلان‌های خودکار
- گزارش‌های تفصیلی

### 4. انعطاف‌پذیری
- پیکربندی قابل تنظیم
- آستانه‌های قابل تغییر
- قابلیت توسعه

## نتیجه‌گیری

سیستم جدید محافظت در برابر Brute Force با ارائه محافظت چندلایه، تشخیص هوشمند و پاسخ‌های تطبیقی، امنیت سیستم را به طور قابل توجهی بهبود داده است. این سیستم نه تنها از حملات Brute Force محافظت می‌کند، بلکه تجربه کاربری مناسب و قابلیت نظارت و مدیریت را نیز فراهم می‌کند. 