
# ๐ฆ DynamicPortManager - README & API DOC

---

## ๐ ูุนุฑู

**DynamicPortManager** ฺฉ ูุงฺูู ูพุดุฑูุชู ู ููุงูู ุจุฑุง ูุฏุฑุช ูพูุฑุชโูุง ุขุฒุงุฏ ู ุงุดุบุงู ุฏุฑ ูพุฑูฺูโูุง ุดุจฺฉูโุง (FastAPI ู ...) ุงุณุช ฺฉู:
- ุงุฒ **ููู ูุงู ุจูโูพุฑูุณูโุง** (filelock) ุจุฑุง ุฌููฺฏุฑ ุงุฒ race condition ุงุณุชูุงุฏู ูโฺฉูุฏ.
- ูุจู ุงุฒ ูุฑ ุฐุฎุฑูุ **ุจฺฉุงูพ ุฎูุฏฺฉุงุฑ** ุงุฒ ูุงู ุฌุณูู ูโฺฏุฑุฏ.
- **ุชุงุฑุฎฺู ุชุบุฑุงุช** ูพูุฑุช ูุนุงู ุฑุง ุจู ุตูุฑุช ูพุงุฑุงูุชุฑฺฉ ูฺฏู ูโุฏุงุฑุฏ.
- ุงุฒ **ูุงฺฏ ุฑูฺฏ ู ุณุงุฎุชุงุฑููุฏ** ู **ูุงฺฏูฺฏ JSON** ุจุฑุง ูุงูุชูุฑูฺฏ ุญุฑููโุง ูพุดุชุจุงู ูโฺฉูุฏ.
- **APIูุง ฺฉุงูู** ุจุฑุง ุงุณุชูุงุฏู ุฏุฑ ูุฑ ุจุฑูุงูู ุฏฺฏุฑ (ูุจุ ูุงูุชูุฑูฺฏุ DevOps ู...) ุฏุงุฑุฏ.
- ุฏุฑ ุจุฑุงุจุฑ ุฎุทุงูุง ูุงูุ ูพูุดูุ ุฏุณุชุฑุณุ ู ... ฺฉุงููุงู ููุงูู ุงุณุช.

---

## ๐๏ธ ูุตุจ ูพุดโูุงุฒูุง

```bash
pip install filelock colorama persiantools fastapi
```

---

## ๐ ุณุงุฎุชุงุฑ ูุงูโูุง

```
project-root/
โ
โโโ utils/
โ   โโโ port_state/
โ       โโโ dynamic_ports.json
โ       โโโ backups/
โ           โโโ dynamic_ports_YYYYMMDD_HHMMSS.json
โ   โโโ dynamic_port_manager.py
โ
โโโ server_fastapi.py
โโโ api_ports.py
```

---

## โ๏ธ ุงุณุชูุงุฏู ุฏุฑ ูพุฑูฺู

### ฑ. **ุงููพูุฑุช ู ููุฏุงุฑุฏู**

```python
from utils.dynamic_port_manager import DynamicPortManager

# ูุฑ ุณุฑูุณ ูโุชูุงูุฏ ูุงู ูุฎุตูุต ุฎูุฏ ุฏุงุดุชู ุจุงุดุฏ
port_manager = DynamicPortManager(
    start=3000,
    end=9000,
    json_path="utils/port_state/dynamic_ports_service1.json",
    refresh_interval=10,   # ุซุงูู
    history_max=50         # ุชุนุฏุงุฏ ุฑฺฉูุฑุฏ ุชุงุฑุฎฺู
)
```

### ฒ. **ุฏุฑุงูุช ูพูุฑุช ุขุฒุงุฏ ู ูุฏุฑุช**

```python
port = port_manager.pick_port()      # ฺฉูุชุฑู ูพูุฑุช ุขุฒุงุฏ ุฑุง ุงูุชุฎุงุจ ู ุงุดุบุงู ูโฺฉูุฏ
port_manager.release_port()          # ูพูุฑุช ูุนุงู ุฑุง ุขุฒุงุฏ ูโฺฉูุฏ
state = port_manager.get_state()     # ุฏุฑุงูุช ูุถุนุช ฺฉุงูู (ุจุฑุง ูุงูุชูุฑูฺฏ)
port_manager.stop()                  # ุขุฒุงุฏุณุงุฒ ููุงุจุน ู ุชููู thread
```

---

## ๐ **ุณุงุฎุชุงุฑ ูุงู ุฌุณูู**

```json
{
  "current_port": 3000,
  "free_ports": [8001, 8002, 8003],
  "used_ports": [3000],
  "port_usage": {"3000": 3, "8001": 1},
  "history": [
    {"time": "1403/05/01 12:00 doshanbe", "prev": null, "new": 3000},
    {"time": "1403/05/01 12:10 doshanbe", "prev": 3000, "new": 8001}
  ],
  "last_checked": "1403/05/01 12:10 doshanbe",
  "change_count": 2,
  "last_error": null,
  "last_error_time": null,
  "settings": {
    "port_range": [3000, 9000],
    "json_path": "utils/port_state/dynamic_ports_service1.json",
    "history_max": 50
  }
}
```

---

## ๐จ **ููููู ูุงฺฏ ุฑูฺฏ ฺฉูุณูู**

```
[1403/05/01 12:10 doshanbe] | PICK       | Active:3000 | Free:[8001...8020](20)   | Used:[3000]             | Note:DynamicPortManager started.
```

---

## ๐ **API ูุณุชูุฏุงุช (FastAPI)**

### **ูพุดโูุงุฒ:**
ุฏุฑ ูุงู `api_ports.py` ุง ูุดุงุจูุ ุงู ฺฉุฏ ุฑุง ูุฑุงุฑ ุฏูุฏ ู ุฏุฑ main ุงูพ ุฎูุฏ ุงุถุงูู ฺฉูุฏ:
```python
from fastapi import FastAPI
from api_ports import router as port_router

app = FastAPI()
app.include_router(port_router, prefix="/api/v1")
```

---

### **ุงูุฏูพููุชโูุง**

#### `GET /api/v1/port/state`
**ุชูุถุญ:** ุฏุฑุงูุช ูุถุนุช ฺฉุงูู ูพูุฑุชโูุง ู ุชูุธูุงุช  
**ูพุงุณุฎ:**
```json
{
  "current_port": 3000,
  "free_ports": [8001, 8002],
  "used_ports": [3000],
  ...
}
```

---

#### `POST /api/v1/port/pick`
**ุชูุถุญ:** ุงูุชุฎุงุจ ู ุงุดุบุงู ฺฉูุชุฑู ูพูุฑุช ุขุฒุงุฏ  
**ูพุงุณุฎ:**
```json
{"status": "success", "port": 3000}
```

---

#### `POST /api/v1/port/release`
**ุชูุถุญ:** ุขุฒุงุฏุณุงุฒ ูพูุฑุช ูุนุงู  
**ูพุงุณุฎ:**
```json
{"status": "success"}
```

---

#### `GET /api/v1/port/free`
**ุชูุถุญ:** ุฏุฑุงูุช ูุณุช ูพูุฑุชโูุง ุขุฒุงุฏ  
**ูพุงุณุฎ:**
```json
{"free_ports": [8001, 8002, 8003]}
```

---

#### `GET /api/v1/port/used`
**ุชูุถุญ:** ุฏุฑุงูุช ูุณุช ูพูุฑุชโูุง ุงุดุบุงู  
**ูพุงุณุฎ:**
```json
{"used_ports": [3000]}
```

---

#### `GET /api/v1/port/history`
**ุชูุถุญ:** ุฏุฑุงูุช ุชุงุฑุฎฺู ุชุบุฑุงุช ูพูุฑุช ูุนุงู  
**ูพุงุณุฎ:**
```json
{"history": [{"time": "...", "prev": null, "new": 3000}, ...]}
```

---

#### `GET /api/v1/port/backup/list`
**ุชูุถุญ:** ูุณุช ุจฺฉุงูพโูุง ุฌุณูู  
**ูพุงุณุฎ:**
```json
{"backups": ["dynamic_ports_20240721_155445.json", ...]}
```

---

#### `GET /api/v1/port/backup/download?filename=...`
**ุชูุถุญ:** ุฏุงูููุฏ ฺฉ ุจฺฉุงูพ ุฎุงุต  
**ูพุงุณุฎ:** ูุงู ุฌุณูู ุจฺฉุงูพ

---

#### `GET /api/v1/port/log/json`
**ุชูุถุญ:** ุฏุฑุงูุช ูุงฺฏ ุณุงุฎุชุงุฑููุฏ (ุจุฑุง ELK ุง ูุงูุชูุฑูฺฏ)  
**ูพุงุณุฎ:**
```json
{
  "status": "ok"
}
```
(ูุงฺฏ ุณุงุฎุชุงุฑููุฏ ุฏุฑ ฺฉูุณูู ฺุงูพ ูโุดูุฏ.)

---

## ๐งโ๐ป **ูฺฉุงุช ุชูุณุนู ู ุดุฎุตโุณุงุฒ**

- ูโุชูุงูุฏ ุจุฑุง ูุฑ ุณุฑูุณุ ฺฉ ูุงู ุฌุณูู ุฌุฏุงฺฏุงูู ุชุนุฑู ฺฉูุฏ.
- ูพุงุฑุงูุชุฑ `history_max` ุฑุง ุจุฑุง ฺฉูุชุฑู ุญุฌู ุชุงุฑุฎฺู ุชุบุฑ ุฏูุฏ.
- ุงฺฏุฑ ูุงุฒ ุจู ูุงฺฏูฺฏ JSON ุจุฑุง ELK ุฏุงุฑุฏุ ุงุฒ ูุชุฏ `log_json` ุงุณุชูุงุฏู ฺฉูุฏ.
- ุงฺฏุฑ ูุงุฒ ุจู ุจฺฉุงูพโฺฏุฑ ุจุดุชุฑ ุฏุงุฑุฏุ ูพูุดู `backups/` ุฑุง ูุงูุชูุฑ ฺฉูุฏ.
- ุงฺฏุฑ ฺูุฏู ุจุฑูุงูู ููุฒูุงู ุฏุงุฑุฏุ ููู ูุงู (filelock) ุงุฒ race condition ุฌููฺฏุฑ ูโฺฉูุฏ.

---

## ๐ก๏ธ **ูพุงุฏุงุฑ ู ุงููุช**

- ุฏุฑ ุตูุฑุช ุฎุฑุงุจ ุดุฏู ุง ุฎุงู ุจูุฏู ูุงู ุฌุณููุ ูุงู ุญุฐู ู ุจุงุฒุณุงุฒ ูโุดูุฏ.
- ููู ุฎุทุงูุง ูุงู ู IO ููุฏู ูโุดููุฏ ู ุจุฑูุงูู ูฺโููุช ฺฉุฑุด ููโฺฉูุฏ.
- ุจฺฉุงูพ ุฎูุฏฺฉุงุฑ ูุจู ุงุฒ ูุฑ ุฐุฎุฑู ุงูุฌุงู ูโุดูุฏ.
- ูพูุดู ู ุฒุฑูพูุดูโูุง ููุดู ุณุงุฎุชู ูโุดููุฏ.

---

## ๐ **ุดุฑูุน ุณุฑุน**

```python
from utils.dynamic_port_manager import DynamicPortManager

pm = DynamicPortManager(3000, 9000, json_path="utils/port_state/dynamic_ports_service1.json")
port = pm.pick_port()
print("Selected port:", port)
pm.release_port()
pm.stop()
```

---

## ๐ฃ **ูพุดููุงุฏุงุช ู ุชูุณุนู ุจุดุชุฑ**

- ุงฺฏุฑ ูุงุฒ ุจู ุงูุฏูพููุช ุง ูุงุจูุช ุฎุงุต ุฏฺฏุฑ ุฏุงุฑุ ฺฉุงูุณุช ุฏุฑ ููู ูพุฑูฺู issue ุจุงุฒ ฺฉู ุง ุจู ุชูุณุนูโุฏููุฏู ูพุงู ุจุฏู!
- ุจุฑุง ูุงูุชูุฑูฺฏ ุญุฑููโุงุ ูโุชูุงู ูุงฺฏูฺฏ JSON ุฑุง ุจู ELK ุง Grafana ุงุฑุณุงู ฺฉู.

---

**ูููู ุจุงุด! ุงู ูุงฺูู ุจุฑุง ูพุฑูฺูโูุง ุญุฑููโุง ู ููุงุณโูพุฐุฑ ุทุฑุงุญ ุดุฏู ุงุณุช.**  
ุงฺฏุฑ ุณูุงู ุง ูุงุฒ ุจู ุฑุงูููุง ุฏุงุดุชุ ูููุฌุง ุจูพุฑุณ!